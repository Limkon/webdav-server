<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台</title>
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/manager.css">
    <style>
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: flex-end;
        }
        .form-grid input, .form-grid button {
            margin-top: 0;
            height: 42px; /* 与 input 对齐 */
        }
        .webdav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>管理后台</h1>
            <a href="/" class="upload-link-btn"><i class="fas fa-arrow-left"></i> 返回文件管理器</a>
        </header>

        <div class="setting-card">
            <h2>高级功能</h2>
            <a href="/scan" class="upload-link-btn" style="background-color: #6f42c1;">
                <i class="fas fa-search-plus"></i> 文件扫描与汇入
            </a>
            <p style="margin-top: 10px;">将伺服器上已存在但未被数据库追踪的文件扫描并汇入系统。</p>
        </div>

        <div class="setting-card" id="webdav-settings-card">
            <h2>WebDAV 挂载管理</h2>
            <p>为指定使用者新增、编辑或删除 WebDAV 伺服器挂载点。</p>
            
            <div class="webdav-controls">
                <label for="webdav-user-select">选择使用者:</label>
                <select id="webdav-user-select">
                    <option value="">正在加载...</option>
                </select>
            </div>
            
            <div class="table-container">
                <table class="user-table" id="webdav-table">
                    <thead>
                        <tr>
                            <th>挂载点名称</th>
                            <th>URL</th>
                            <th>使用者名称</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="webdav-table-body"></tbody>
                </table>
            </div>

            <h3 style="margin-top: 20px;">新增或编辑 WebDAV 挂载</h3>
            <form id="webdav-form" style="display: none;">
                <input type="hidden" id="webdav-id">
                <div class="form-grid">
                    <input type="text" id="webdav-mount-name" placeholder="挂载点名称 (例如 MyNAS)" required>
                    <input type="url" id="webdav-url" placeholder="WebDAV URL" required>
                    <input type="text" id="webdav-username" placeholder="使用者名称" required>
                    <input type="password" id="webdav-password" placeholder="密码 (留空则不变更)">
                    <button type="submit" id="save-webdav-btn">储存设定</button>
                    <button type="button" id="clear-webdav-form-btn" style="background-color: #6c757d;">清除表单</button>
                </div>
            </form>
        </div>

        <div class="setting-card">
            <h2>使用者管理</h2>
            <form id="add-user-form">
                <div class="form-grid">
                    <input type="text" id="new-username" placeholder="新用户名" required>
                    <input type="password" id="new-password" placeholder="新密码 (至少4位)" required>
                    <button type="submit">新增使用者</button>
                </div>
            </form>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>使用者名称</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>
    <script src="/vendor/axios/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addUserForm = document.getElementById('add-user-form');
            const newUsernameInput = document.getElementById('new-username');
            const newPasswordInput = document.getElementById('new-password');
            const userTableBody = document.getElementById('user-table-body');
            
            const webdavUserSelect = document.getElementById('webdav-user-select');
            const webdavTableBody = document.getElementById('webdav-table-body');
            const webdavForm = document.getElementById('webdav-form');
            const webdavIdInput = document.getElementById('webdav-id');
            const webdavMountNameInput = document.getElementById('webdav-mount-name');
            const webdavUrlInput = document.getElementById('webdav-url');
            const webdavUsernameInput = document.getElementById('webdav-username');
            const webdavPasswordInput = document.getElementById('webdav-password');
            const saveWebdavBtn = document.getElementById('save-webdav-btn');
            const clearWebdavFormBtn = document.getElementById('clear-webdav-form-btn');
            let allUsers = [];

            function clearWebdavForm() {
                webdavForm.reset();
                webdavIdInput.value = '';
                webdavMountNameInput.disabled = false;
                saveWebdavBtn.textContent = '储存设定';
            }

            async function loadWebdavSettingsForUser(userId) {
                webdavTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">正在加载...</td></tr>';
                if (!userId) {
                    webdavTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">请先选择一个使用者。</td></tr>';
                    webdavForm.style.display = 'none';
                    return;
                }
                webdavForm.style.display = 'block';
                clearWebdavForm();

                try {
                    const res = await axios.get(`/api/admin/webdav-configs?userId=${userId}`);
                    const configs = res.data;
                    webdavTableBody.innerHTML = '';
                    if (configs.length === 0) {
                         webdavTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">此使用者尚未设定任何 WebDAV 挂载。</td></tr>';
                    } else {
                        configs.forEach(config => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${config.mount_name}</td>
                                <td>${config.url}</td>
                                <td>${config.username}</td>
                                <td class="actions">
                                    <button class="edit-webdav-btn" data-id="${config.id}">编辑</button>
                                    <button class="delete-webdav-btn" data-id="${config.id}" style="background-color: #dc3545;">删除</button>
                                </td>
                            `;
                            webdavTableBody.appendChild(row);
                        });
                    }
                } catch (error) {
                     webdavTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载 WebDAV 设定失败。</td></tr>';
                }
            }
            
            webdavUserSelect.addEventListener('change', () => {
                loadWebdavSettingsForUser(webdavUserSelect.value);
            });

            clearWebdavFormBtn.addEventListener('click', clearWebdavForm);

            webdavForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = webdavUserSelect.value;
                if (!userId) {
                    alert('请先选择一个使用者！');
                    return;
                }

                const payload = {
                    id: webdavIdInput.value || undefined,
                    userId: userId,
                    mount_name: webdavMountNameInput.value.trim(),
                    url: webdavUrlInput.value.trim(),
                    username: webdavUsernameInput.value.trim(),
                    password: webdavPasswordInput.value // 允许为空
                };

                try {
                    await axios.post('/api/admin/webdav-config', payload);
                    alert('WebDAV 设定已储存!');
                    clearWebdavForm();
                    loadWebdavSettingsForUser(userId);
                } catch (error) {
                    alert('储存失败: ' + (error.response?.data?.message || '服务器错误'));
                }
            });
            
            webdavTableBody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const userId = webdavUserSelect.value;

                if (target.classList.contains('edit-webdav-btn')) {
                     const res = await axios.get(`/api/admin/webdav-configs?userId=${userId}`);
                     const config = res.data.find(c => String(c.id) === id);
                     if (config) {
                         webdavIdInput.value = config.id;
                         webdavMountNameInput.value = config.mount_name;
                         webdavMountNameInput.disabled = true; // 不允许修改挂载名
                         webdavUrlInput.value = config.url;
                         webdavUsernameInput.value = config.username;
                         webdavPasswordInput.value = '';
                         webdavPasswordInput.placeholder = "密码 (留空则不变更)";
                         saveWebdavBtn.textContent = '更新设定';
                         webdavMountNameInput.scrollIntoView();
                     }
                }

                if (target.classList.contains('delete-webdav-btn')) {
                    if (confirm('确定要删除此 WebDAV 挂载吗？其对应的所有文件记录也将被删除！')) {
                        try {
                            await axios.delete(`/api/admin/webdav-config/${id}`);
                            alert('设定已删除。');
                            loadWebdavSettingsForUser(userId);
                        } catch (error) {
                            alert('删除失败: ' + (error.response?.data?.message || '服务器错误'));
                        }
                    }
                }
            });
            
            async function loadUsers() {
                try {
                    const res = await axios.get('/api/admin/all-users');
                    allUsers = res.data;
                    
                    // 填充使用者管理列表
                    userTableBody.innerHTML = '';
                    allUsers.filter(u => u.username !== 'admin').forEach(user => {
                         const row = `
                            <tr>
                                <td>${user.username}</td>
                                <td class="actions">
                                    <button class="change-pass-btn" data-userid="${user.id}" data-username="${user.username}">改密码</button>
                                    <button class="delete-user-btn" data-userid="${user.id}" data-username="${user.username}">删除</button>
                                </td>
                            </tr>
                        `;
                        userTableBody.innerHTML += row;
                    });

                    // 填充 WebDAV 管理的使用者下拉选单
                    webdavUserSelect.innerHTML = '<option value="" disabled selected>-- 请选择一个使用者 --</option>';
                    allUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        webdavUserSelect.appendChild(option);
                    });
                } catch (error) {
                    userTableBody.innerHTML = '<tr><td colspan="2">加载使用者失败</td></tr>';
                    webdavUserSelect.innerHTML = '<option value="">加载失败</option>';
                }
            }

            addUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = newUsernameInput.value.trim();
                const password = newPasswordInput.value.trim();
                if (!username || !password) return;

                try {
                    await axios.post('/api/admin/add-user', { username, password });
                    newUsernameInput.value = '';
                    newPasswordInput.value = '';
                    alert('使用者新增成功！');
                    loadUsers(); // 重新加载所有使用者列表
                } catch (error) {
                    alert('新增失败：' + (error.response?.data?.message || '服务器错误'));
                }
            });

            userTableBody.addEventListener('click', async (e) => {
                const target = e.target;
                const userId = target.dataset.userid;
                const username = target.dataset.username;

                if (target.classList.contains('change-pass-btn')) {
                    const newPassword = prompt(`请为使用者 "${username}" 输入新密码：`);
                    if (newPassword && newPassword.length >= 4) {
                        try {
                            await axios.post('/api/admin/change-password', { userId, newPassword });
                            alert(`使用者 "${username}" 的密码已更新。`);
                        } catch (error) {
                            alert('密码更新失败：' + (error.response?.data?.message || '服务器错误'));
                        }
                    } else if (newPassword) {
                        alert('密码长度至少需要 4 个字元。');
                    }
                }

                if (target.classList.contains('delete-user-btn')) {
                    if (confirm(`确定要删除使用者 "${username}" 吗？\n此操作将会删除该使用者的所有档案和资料夹，且无法复原！`)) {
                        try {
                            await axios.post('/api/admin/delete-user', { userId });
                            alert(`使用者 "${username}" 已被删除。`);
                            loadUsers();
                        } catch (error) {
                             alert('删除失败：' + (error.response?.data?.message || '服务器错误'));
                        }
                    }
                }
            });

            loadUsers();
        });
    </script>
</body>
</html>
